# -*-coding:utf-8-*-#此程序可以爬取淘宝网上的图片#解决了需要登陆验证的问题#2019-06-24 亲测有效import requestsimport urllib.requestimport urllib.parseimport reimport requestsimport sslssl._create_default_https_context = ssl._create_unverified_context()#要查找的关键字keyname="短裙"key=urllib.request.quote(keyname)#编码  处理不了中文 所以处理一下#headers里面加了ua和cookie，如果没有cookie就不能登陆headers = {'user-agent':'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36',"cookie":"_uab_collina=155015397312624342284555; thw=cn; hng=CN%7Czh-CN%7CCNY%7C156; __guid=204189581.1787283599253608000.1550153972933.129; lid=%E8%B4%AD%E7%89%A9%E5%B0%8F%E7%B1%B377; tracknick=%5Cu8D2D%5Cu7269%5Cu5C0F%5Cu7C7377; tg=0; enc=LoQXI%2FBTth%2F%2FcwBZaFK%2FtcLa95sBxPFaPjxClOfhIfrKlE9L%2BkpnyKP6fgLOczV2YaaKJeL4XJWJ1ASjLHN%2B2g%3D%3D; x=e%3D1%26p%3D*%26s%3D0%26c%3D0%26f%3D0%26g%3D0%26t%3D0%26__ll%3D-1%26_ato%3D0; _cc_=UIHiLt3xSw%3D%3D; miid=1275592120139724465; cna=3W1HFfXMoSsCAT2EitgjFmTe; t=cac95ca387ff294c3f11eecb25a2fd99; _tb_token_=amScSycRlyl4w61TslsQ; cookie2=1afb2a13cd0c0e33be37061bf4b607ec; v=0; cookieCheck=15117; monitor_count=9; l=bBS8mCZ4vCQpdykQBOfNNuI8LPbtwIOfCsPzw4OG4ICPOF1p7DkOWZt12bY9C3GVZ6O953J4RKM8ByT5eyCV.; isg=BGZmzIBOBhjhcdKV_6QqznDgt9wo76tk0yRgZlAOZwl10wPtvNP4ET7hK496-6IZ"}opener=urllib.request.build_opener()opener.addHeaders=[headers]urllib.request.install_opener(opener)#淘宝登陆的urllogin_url ="https://login.taobao.com/member/login.jhtml"#记录登陆状态方便后续请求ponse = requests.session()mydata=urllib.parse.urlencode({    "TPL_username":"yqfzl00",    "TPL_password_1":"984321745whl"}).encode("utf-8")#进行相应的编码为中文#记录登陆请求状态ponse.post(login_url,headers=headers,data=mydata)#淘宝查询的网址#https://s.taobao.com/search?q=%E7%9F%AD%E8%A3%99&imgfile=&js=1&stats_click=search_radio_all%3A1&initiative_id=staobaoz_20190624&ie=utf8for i in range(0,1):    #构建要获取图片的网址    url="https://s.taobao.com/list?q="+key+"&cat=16&style=grid&seller_type=taobao&spm=a219r.lm874.1000187.1&bcoffset=0&s="+str(i*60)    #构建出来的网址https://s.taobao.com/list?q=%E7%9F%AD%E8%A3%99&cat=16&style=grid&seller_type=taobao&spm=a219r.lm874.1000187.1&bcoffset=0&s=1    data= ponse.get(url,headers=headers).content.decode("utf-8")    '''    bian = re.compile(r'\xa9')    data = re.sub(bian,'',data)    fh=open("/home/CORPUSERS/xp024975/file1","w")    fh.write(data)    fh.close()    '''    pat='pic_url":"//(.*?)"'    imagelist=re.compile(pat).findall(data)    print(imagelist)    print('Number is :',len(imagelist))    for j in range(0,len(imagelist)):        thisimg=imagelist[j]        thisimgurl="http://"+thisimg        file="/home/CORPUSERS/xp024975/img/"+str(i)+str(j)+".jpg"        #file="F:/img/"+str(i)+str(j)+".jpg"        # urllib.request.get(thisimgurl,filename=file,verify=False)        # 使用上面的语句，容易出现urllib.error.ContentTooShortError: <urlopen error retrieval incomplete: got only 4035 out of 755952 bytes>        # 的问题，原因可能是网络不稳定，需要改写        try:            urllib.request.urlretrieve(thisimgurl,filename=file)        except urllib.ContentTooShortError:            print('netowork bad')            urllib.request.urlretrieve(thisimgurl,filename=file)